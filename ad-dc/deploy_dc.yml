# Author: Lucas Brown
# Playbook: Deploy AD
# Purpose: Turn a Windows host into a Domain Controller by installing AD DS & DNS creating a new domain, and then creating an OU, group, and user.

  - name: Deploy AD
    hosts: windows

    vars:
      domain_name: "hockey.cdtcharlie.com" # FQDN
      netbios_name: "HOCKEY1"
      safe_mode_password: "Password123!" # Directory Services Restore Mode (DSRM) password for the domain controller
      dc_hostname: "DC1"
      ou_name: "GreyTeam" # Organizational Unit (OU) name to create inside the new domain
      group_name: "BlueTeamAdmins" # Security group name to create inside the OU

      # User details for a sample/domain user account created in the OU
      user_sam: "alice"
      user_given: "Alice"
      user_surname: "Operator"
      user_password: "ChangeMe_User123!"

    tasks:
    - name: Set DC hostname
      ansible.windows.win_hostname:
        name: "{{ dc_hostname }}"
      register: rename_result

    - name: Reboot if hostname change requires it
      ansible.windows.win_reboot:
        msg: "Rebooting after hostname changes"
      when: rename_result.reboot_required

    - name: Install Active Directory Domain Services (ADDS)
      ansible.windows.win_feature:
        name: AD-Domain-Services
        state: present
        include_management_tools: true # installs RSAT/management tools too
      register: ad_feature_result

    - name: Install DNS
      ansible.windows.win_feature:
        name: DNS
        state: present
        include_management_tools: true
      register: dns_feature_result

    - name: Reboot after ADDS/DNS feature install if needed
      # If either role install required a reboot, reboot before continuing
      ansible.windows.win_reboot:
        msg: "Rebooting after ADDS/DNS feature install"
      when: (ad_feature_result.reboot_required | default(false)) or (dns_feature_result.reboot_required | default(false))
    
    - name: Create AD domain and reboot
      microsoft.ad.domain: 
        dns_domain_name: "{{ domain_name }}"
        domain_netbios_name: "{{ netbios_name }}"        
        safe_mode_password: "{{ safe_mode_password }}"
        create_dns_delegation: false
        install_dns: true
        reboot: true
      register: domain_create

    - name: Reboot after domain creation / DC promotion if needed
      ansible.windows.win_reboot:
        msg: "Rebooting after domain creation / DC promotion"
      when: domain_create.reboot_required | default(true)

    - name: Create OU
      # This path builds: DC=hockey,DC=cdtcharlie,DC=com from the domain_name.
      microsoft.ad.ou:
        name: "{{ ou_name }}"
        path: "DC={{ (domain_name | trim).split('.') | join(',DC=') }}"
        state: present

    - name: Create group in OU
      microsoft.ad.group:
        name: "{{ group_name }}"
        path: "OU={{ ou_name }},DC={{ domain_name.split('.') | join(',DC=') }}"
        scope: global
        state: present

    - name: Create user in OU
      microsoft.ad.user:
        name: "{{ user_sam }}"
        firstname: "{{ user_given }}"
        lastname: "{{ user_surname }}"
        password: "{{ user_password }}"
        path: "OU={{ ou_name }},DC={{ domain_name.split('.') | join(',DC=') }}"
        enabled: true
        state: present

    - name: Add user to group
      # Uses PowerShell to add the user to the group.
      # "-ErrorAction SilentlyContinue" prevents the task from failing if the user is already a member.
      ansible.windows.win_powershell:
        script: |
          Import-Module ActiveDirectory
          Add-ADGroupMember -Identity "{{ group_name }}" -Members "{{ user_sam }}" -ErrorAction SilentlyContinue
